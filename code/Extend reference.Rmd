---
title: "Extend reference"
output: html_notebook
---

# Setup
```{r}
library(Biostrings)
library(here)
library(tidyverse)
```

# Read in data
```{r}
# Read in current version of reference
current <- 
     here('data', 
          'processed', 
          'dada2-compatible', 
          'trnL', 
          'trnLGH_update.fasta') %>% 
     readDNAStringSet()
```

# QC

Common errors:

- Duplicated sequences
- Sequences with non-AGCT nucleotides

```{r}
# Organize as dataframe for referencing back to accession
current.df <- 
     data.frame(
          name = names(current),
          seq = current
     ) 

row.names(current.df) <- NULL
```

```{r}
# Separate accession number from species name
current.df <- 
     separate(current.df,
              name,
              sep = ' ',
              into = c('accession', 'species'),
              extra = 'merge',
              remove = FALSE)
```

```{r}
# Combine species name and sequence to make unique identifier
current.df <- mutate(current.df,
                     ID = paste(species, seq))
```

Now, check for errors:

```{r}
any(duplicated(current.df$ID))
```

```{r}
# Check for degenerate nucleotide characters
grep('[AGCT]*[^AGCT]+', current.df$seq)
```

# Add new sequences

```{r}
# Read in sequences to be added
additional <- 
     here('data', 'processed', 'sql-compatible', 
          # '20210426_kenya-abc additions.csv') %>%
          # '20210607_chomp-onr additions.csv') %>%
          # '20210617_pomms additions.csv') %>%
          '20210814_pomms additions.csv') %>%
     read_csv()

# Format as a DNAStringSet
addseqs <- additional$sequence
names(addseqs) <- additional$species_name
```

Check if any are already present by a combination of their name and sequence. Needs to be this combo, because we want to duplicate a sequence if we also 
```{r}
# Set of current sequences
head(names(current))
names(current) <- gsub('^\\d+\\s', 
                       '',
                       names(current))

head(names(current))
```

```{r}
# Make joint string for each sequence
joint.current <- paste(names(current), 
               current, 
               sep = '_')

head(joint.current)
```

```{r}
# Double-check no duplicates
any(duplicated(joint.current))
```

```{r}
# Proposed additions
joint.add <- paste(names(addseqs), 
               addseqs, 
               sep = '_')

head(joint.add)
```

```{r}
length(joint.add)
# If any sequences are duplicated
if (any(joint.add %in% joint.current)){
     # Show what's duplicated
     print(addseqs[which(joint.add %in% joint.current)])
     # Remove it
     joint.add <- joint.add[!(joint.add %in% joint.current)]
}
# Check difference in length
length(joint.add)
```

```{r}
# Combine
joint <- c(joint.current, joint.add)
```

```{r}
# Re-index
joint <- 
     joint %>% 
     sort() %>% 
     paste(
          seq_along(.),
          .
     )
```

```{r}
# Separate sequence and name
split <- str_split(joint, 
                   pattern = '_')

new <- lapply(split, '[[', 2)
names(new) <- lapply(split, '[[', 1)
```


```{r}
# Save
new <- DNAStringSet(unlist(new))
new
```

```{r}
# Write to file
writeXStringSet(new,
                here('data', 'processed', 'dada2-compatible', 'trnL',
                     'trnLGH.fasta'))
```

After this, update in Git.